<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HATPI Data</title>
  <link rel="stylesheet" href="/static/lightcurves.css">
  <link rel="icon" href="/static/images/favicon.png" type="image/x-icon">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='js9/js9-allinone.css') }}">
  <script src="{{ url_for('static', filename='js9/js9-allinone.js') }}"></script>
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>

</head>

<body class="lightcurves-page">


  <!-- ‚îÄ‚îÄ Top Navigation Bar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <header id="top-navbar">
    <nav class="top-nav-links">
      <a href="{{ url_for('frames_page') }}"
        class="top-nav-btn {{ 'active' if active_page=='frames' else 'inactive' }}">
        Frames
      </a>
      <a href="{{ url_for('lightcurves_page') }}"
        class="top-nav-btn {{ 'active' if active_page=='lightcurves' else 'inactive' }}">
        Light&nbsp;Curves
      </a>
    </nav>
    {% if current_user.is_authenticated %}
    <a href="{{ url_for('auth.logout') }}" class="top-nav-btn inactive logout-push">Log&nbsp;out</a>
    {% endif %}


  </header>

  <!-- ‚îÄ‚îÄ Left Sidebar Navigation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <nav id="lightcurves-navigation">
    <a href="https://hatpi.org" class="nav-home-link">üè°</a>

    <div id="search-form-sidebar"> <!-- ‚¨Ö preserves your original CSS -->

      <h2 class="nav-section-title">
        <img src="/static/icons/search.svg" alt="Search Icon" class="nav-icon">
        Search
      </h2>

      {% if active_page == 'frames' %}
      <!-- full form only on Frames view -->
      <form method="POST">
        <label for="ra">
          <img src="/static/icons/RA.png" alt="RA Icon" class="small-icon">
          RA&nbsp;(deg)
        </label>
        <input type="text" id="ra" name="ra" placeholder="e.g. 180.07" value="{{ ra|default('') }}" />

        <label for="dec">
          <img src="/static/icons/DEC.png" alt="DEC Icon" class="small-icon">
          DEC&nbsp;(deg)
        </label>
        <input type="text" id="dec" name="dec" placeholder="e.g. -83.553" value="{{ dec|default('') }}" />

        <label for="date_type">Date&nbsp;Type</label>
        <select id="date_type" name="date_type">
          <option value="datetime" {% if date_type=='datetime' %}selected{% endif %}>
            datetime
          </option>
          <option value="JD" {% if date_type=='JD' %}selected{% endif %}>
            JD
          </option>
        </select>
        <small>If ‚Äúdatetime‚Äù, use YYYY-MM-DD.<br>
          If ‚ÄúJD‚Äù, enter a float such as 2459990.5.</small>

        <label for="date_min">Date&nbsp;Min</label>
        <input type="text" id="date_min" name="date_min" placeholder="YYYY-MM-DD or 2459990.5"
          value="{{ date_min_input|default('') }}" />

        <label for="date_max">Date&nbsp;Max</label>
        <input type="text" id="date_max" name="date_max" placeholder="YYYY-MM-DD or 2459991.5"
          value="{{ date_max_input|default('') }}" />

        <button type="submit" class="visit-button">Search</button>
      </form>
      {% else %}
      <!-- Light-Curves view: GAIA-ID search only -->
      <form method="POST">
        <label for="gaia_id">
          <img src="/static/icons/star.png" alt="GAIA Icon" class="small-icon">
          Gaia DR2 ID
        </label>
        <input type="text" id="gaia_id" name="gaia_id" placeholder="e.g.&nbsp;617917189689396864"
          value="{{ gaia_id|default('') }}" />

        <button type="submit" class="visit-button">Search</button>
      </form>
      {% endif %}

    </div> <!-- /#search-form-sidebar -->
  </nav>


  <!-- Main content area for query results -->
  <main>
    {% if show_upcoming %}
    <section id="upcoming">
      <div class="section-card">
        <div class="content-area">
          <h1 class="section-title">Upcoming Data Releases</h1>
          <p>
            We‚Äôre excited to announce that light curves and high-resolution image stamps will soon be available
            for direct viewing and download. In the meantime, our frame search feature lets you explore HATPI‚Äôs
            observations to determine if we‚Äôve captured the astronomical phenomena you‚Äôre researching.
          </p>
        </div>
      </div>
    </section>
    {% endif %}


    <section id="results">

      {# -----------------------------------------------------------------------
      0. Global status messages
      ----------------------------------------------------------------------- #}
      {% if error %}
      <p class="error-text">{{ error }}</p>
      {% endif %}

      {% if message %}
      <p class="message-text">{{ message }}</p>
      {% endif %}

      {% if lightcurve_path %}
      <!-- Light-curve card ------------------------------------------------- -->
      <div class="section-card">
        <div class="title-container">
          <h2 class="section-title">Light Curve</h2>
        </div>
        <!-- series selector -->
        <div id="series-switch" class="radio-switch" style="margin-bottom:20px;">
          {% for sname in lc_series.keys()|sort %}
          <label class="container">
            <input type="radio" name="seriesType" value="{{ sname }}" {% if loop.first %}checked{% endif %}>
            <span class="checkmark"></span>
            {{ sname }}
          </label>
          {% endfor %}
        </div>
        <div class="content-area">
          <p><strong>Stitched FITS:</strong> {{ lightcurve_path }}</p>
          <div id="lc-plot" style="width:100%;height:500px;"></div>
        </div>
      </div>

      <!-- Inline Plotly build -->
      <script>
        /* ---- data injected by Jinja ---- */
        const lcTime = {{ lc_time   | tojson }};
        const lcSeries = {{ lc_series | tojson }};

        /* ---- initial series (first key) ---- */
        const defaultKey = Object.keys(lcSeries)[0];
        const trace = {
          x: lcTime,
          y: lcSeries[defaultKey],
          mode: 'markers',
          marker: { size: 3 },
          name: defaultKey
        };
        const layout = {
          margin: { l: 60, r: 20, t: 30, b: 40 },
          xaxis: { title: 'Time (BJD / JD)' },
          yaxis: { title: 'Magnitude (mag)', autorange: 'reversed' }
        };
        Plotly.newPlot('lc-plot', [trace], layout);

        /* ---- radio-button listener ---- */
        document.querySelectorAll('input[name="seriesType"]').forEach(radio => {
          radio.addEventListener('change', () => {
            const key = radio.value;
            Plotly.restyle('lc-plot', { y: [lcSeries[key]], name: [key] });
          });
        });
      </script>

      {% endif %}


      {# -----------------------------------------------------------------------
      1. Show ‚ÄúAwaiting search‚Äù card if no search has been run yet.
      The backend sets frames = None before any query is executed.
      ----------------------------------------------------------------------- #}
      {% if active_page == 'frames' %}
      {% if object_total is not defined and twilight_total is not defined %}
      <div class="section-card">
        <div class="title-container">
          <div class="title-row">
            <h1 class="section-title">‚¨ÖÔ∏è Awaiting search</h1>
          </div>
        </div>
        <div class="content-area"><!-- placeholder --></div>
      </div>

      {# -----------------------------------------------------------------------
      2. Show results: two independent cards
      ‚Ä¢ #object-card ‚Äì visible by default
      ‚Ä¢ #twilight-card ‚Äì hidden until the radio switch is clicked
      ----------------------------------------------------------------------- #}
      {% elif object_total or twilight_total %}
      {% if twilight_total > 0 %}
      <div id="frame-switch" class="radio-switch">
        <!-- Object button -->
        <label class="container">
          <input type="radio" name="frameType" value="object" {% if current_view=='object' %}checked{% endif %}>
          <span class="checkmark"></span>
          Object Frames
        </label>

        <!-- Twilight button -->
        <label class="container">
          <input type="radio" name="frameType" value="twilight" {% if current_view=='twilight' %}checked{% endif %}>
          <span class="checkmark"></span>
          Twilight Frames *
        </label>
      </div>
      {% endif %}






      {# ===== OBJECT CARD ================================================== #}
      <div id="object-card" class="section-card" {% if current_view=='twilight' %}style="display:none;" {% endif %}>

        <div class="title-container">

          {# --- first row: count badge + radio switch ---------------------- #}
          <div class="title-row">
            <div class="search-info-box">
              Object Frames Found: {{ object_total }}
            </div>
          </div>

          {# --- second row: query details ---------------------------------- #}
          <div class="title-row search-info-row">
            <div class="search-info-box">RA: {{ ra|default('N/A') }}</div>
            <div class="search-info-box">DEC: {{ dec|default('N/A') }}</div>
            <div class="search-info-box">Date Min: {{ date_min_input|default('N/A') }}</div>
            <div class="search-info-box">Date Max: {{ date_max_input|default('N/A') }}</div>
          </div>
        </div> {# /title-container #}

        <div class="content-area">
          <div class="table-wrapper">

            {# --------- pagination form for OBJECT frames -------------------- #}
            <form method="post" class="pagination-form">

              {# preserve original search fields #}
              <input type="hidden" name="ra" value="{{ ra }}">
              <input type="hidden" name="dec" value="{{ dec }}">
              <input type="hidden" name="date_type" value="{{ date_type }}">
              <input type="hidden" name="date_min" value="{{ date_min_input }}">
              <input type="hidden" name="date_max" value="{{ date_max_input }}">

              {# keep the *other* card‚Äôs page number so it isn‚Äôt lost #}
              <input type="hidden" name="page_twl" value="{{ page_twl }}">

              {# remember which card is currently visible #}
              <input type="hidden" name="view" value="object">

              {# pagination buttons for OBJECT card #}
              <button type="submit" name="page_obj" value="{{ page_obj - 1 }}" {% if page_obj <=1 %}disabled{% endif
                %}>‚Üê Prev</button>

              <span>Page {{ page_obj }} of {{ total_pages_obj }}</span>

              <button type="submit" name="page_obj" value="{{ page_obj + 1 }}" {% if page_obj>= total_pages_obj
                %}disabled{% endif %}>Next ‚Üí</button>
            </form>

            {# --------- OBJECT frames table --------------------------------- #}
            <table class="frames-table">
              <thead>
                <tr>
                  <th>Object</th>
                  <th class="ihu-header">
                    IHU
                    <span class="info-icon" tabindex="0" aria-label="Show IHU layout">&#9432;
                      <span class="tooltip-box">
                        <img src="{{ url_for('static', filename='images/ihu_layout.png') }}"
                          alt="Overhead IHU (CCD) layout" class="tooltip-img">
                        <p class="tooltip-caption">
                          Overhead layout of the HATPI instrument.
                          Each square represents an Instrument Holder Unit (IHU)
                          that houses one CCD
                        </p>
                      </span>
                    </span>
                  </th>
                  <th>Frame Number</th>
                  <th>Observation Time (UTC)</th>
                  <th>Exposure (seconds)</th>
                  <th>Sky Background (ADU)</th>
                  <th>Moon Distance (deg)</th>
                  <th>Sun Elevation (deg)</th>
                  <th>Calibrated</th>
                  <th>Subtracted</th>
                </tr>
              </thead>
              <tbody>
                {% for f in object_frames %}
                <tr>
                  <td>{{ f.OBJECT }}</td>
                  <td>{{ f.IHUID }}</td>
                  <td>{{ f.FNUM }}</td>
                  <td>{{ f.datetime_obs }}</td>
                  <td>{{ f.EXPTIME }}</td>
                  <td>{{ f.sky_bg|default('N/A') }}</td>
                  <td>{{ f.moondist|default('N/A') }}</td>
                  <td>{{ f.sunelev|default('N/A') }}</td>
                  <td>
                    <button type="button" class="view-btn visit-button" data-kind="red" data-ihuid="{{ f.IHUID }}"
                      data-fnum="{{ f.FNUM }}">View</button>
                  </td>
                  <td>
                    <button type="button" class="view-btn visit-button" data-kind="sub" data-ihuid="{{ f.IHUID }}"
                      data-fnum="{{ f.FNUM }}">View</button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>

          </div> {# /table-wrapper #}
        </div> {# /content-area #}
      </div> {# /object-card #}

      {# ===== TWILIGHT CARD =============================================== #}
      {% if twilight_total > 0 %}
      <div id="twilight-card" class="section-card" {% if current_view=='object' %}style="display:none;" {% endif %}>

        <div class="title-container">

          {# --- header: count only ----------------------------------------- #}
          <div class="title-row">
            <div class="search-info-box">
              Twilight Frames Found: {{ twilight_total }}
            </div>
            <span class="twilight-note">
              <p>* Please note: Light curves will not be produced for twilight frames</p>
            </span>
          </div>


          {# --- query details row (same as object) ------------------------- #}
          <div class="title-row search-info-row">
            <div class="search-info-box">RA: {{ ra|default('N/A') }}</div>
            <div class="search-info-box">DEC: {{ dec|default('N/A') }}</div>
            <div class="search-info-box">Date Min: {{ date_min_input|default('N/A') }}</div>
            <div class="search-info-box">Date Max: {{ date_max_input|default('N/A') }}</div>
          </div>
        </div> {# /title-container #}

        <div class="content-area">
          <div class="table-wrapper">

            {# --------- pagination form for TWILIGHT frames ----------------- #}
            <form method="post" class="pagination-form">

              {# preserve original search fields #}
              <input type="hidden" name="ra" value="{{ ra }}">
              <input type="hidden" name="dec" value="{{ dec }}">
              <input type="hidden" name="date_type" value="{{ date_type }}">
              <input type="hidden" name="date_min" value="{{ date_min_input }}">
              <input type="hidden" name="date_max" value="{{ date_max_input }}">

              {# keep the *other* card‚Äôs page number so it isn‚Äôt lost #}
              <input type="hidden" name="page_obj" value="{{ page_obj }}">

              {# remember which card is currently visible #}
              <input type="hidden" name="view" value="twilight">

              {# pagination buttons for TWILIGHT card #}
              <button type="submit" name="page_twl" value="{{ page_twl - 1 }}" {% if page_twl <=1 %}disabled{% endif
                %}>‚Üê Prev</button>

              <span>Page {{ page_twl }} of {{ total_pages_twl }}</span>

              <button type="submit" name="page_twl" value="{{ page_twl + 1 }}" {% if page_twl>= total_pages_twl
                %}disabled{% endif %}>Next ‚Üí</button>
            </form>

            {# --------- TWILIGHT frames table ------------------------------ #}
            <table class="frames-table">
              <thead>
                <tr>
                  <th>Object</th>
                  <th class="ihu-header">
                    IHU
                    <span class="info-icon" tabindex="0" aria-label="Show IHU layout">&#9432;
                      <span class="tooltip-box">
                        <img src="{{ url_for('static', filename='images/ihu_layout.png') }}"
                          alt="Overhead IHU (CCD) layout" class="tooltip-img">
                        <p class="tooltip-caption">
                          Overhead layout of the HATPI instrument.
                          Each square represents an Instrument Holder Unit (IHU)
                          that houses one CCD
                        </p>
                      </span>
                    </span>
                  </th>
                  <th>Frame Number</th>
                  <th>Observation Time (UTC)</th>
                  <th>Exposure (seconds)</th>
                  <th>Sky Background (ADU)</th>
                  <th>Moon Distance (deg)</th>
                  <th>Sun Elevation (deg)</th>
                  <th>Calibrated</th>
                  <th>Subtracted</th>
                </tr>
              </thead>
              <tbody>
                {% for f in twilight_frames %}
                <tr>
                  <td>{{ f.OBJECT }}</td>
                  <td>{{ f.IHUID }}</td>
                  <td>{{ f.FNUM }}</td>
                  <td>{{ f.datetime_obs }}</td>
                  <td>{{ f.EXPTIME }}</td>
                  <td>{{ f.sky_bg|default('N/A') }}</td>
                  <td>{{ f.moondist|default('N/A') }}</td>
                  <td>{{ f.sunelev|default('N/A') }}</td>
                  <td>
                    <button type="button" class="view-btn visit-button" data-kind="red" data-ihuid="{{ f.IHUID }}"
                      data-fnum="{{ f.FNUM }}">View</button>
                  </td>
                  <td>
                    <button type="button" class="view-btn visit-button" data-kind="sub" data-ihuid="{{ f.IHUID }}"
                      data-fnum="{{ f.FNUM }}">View</button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>

          </div> {# /table-wrapper #}
        </div> {# /content-area #}
      </div> {# /twilight-card #}
      {% endif %}

      {# -----------------------------------------------------------------------
      3. No frames found in either list
      ----------------------------------------------------------------------- #}
      {% else %}
      <div class="section-card">
        <div class="title-container">
          <div class="title-row">
            <h2 class="section-title">Results</h2>
          </div>
        </div>
        <div class="content-area">
          <p>No frames found for that coordinate &amp; date range.</p>
        </div>
      </div>
      {% endif %}
      {% endif %}

    </section>


    <!-- CLI Query Card -->
    {% if active_page == 'frames' %}
    <div class="cli-section">
      <h1 class="section-title">Query the API from Your Terminal</h1>
      <div class="cli-query-container">

        <div class="cli-block">
          <pre id="pre-json" class="cli-query">
    # JSON
    <span class="command">curl</span> <span class="option">-X</span> <span class="value">POST</span> \
      <span class="option">-H</span> <span class="string">"Content-Type: application/json"</span> \
      <span class="option">-d</span> <span class="string">'{ "ra": "180.07", "dec": "-83.553", "date_type": "JD", "date_min": "2460048.60", "date_max": "2460048.63" }'</span> \
      <span class="url">'https://hatpi.org/api/data'</span>
          </pre>
          <button class="copy-button" data-target="pre-json">Copy JSON üìã</button>
        </div>

        <div class="cli-block">
          <pre id="pre-csv" class="cli-query">
    # CSV
    <span class="command">curl</span> <span class="option">-X</span> <span class="value">POST</span> \
      <span class="option">-H</span> <span class="string">"Content-Type: application/json"</span> \
      <span class="option">-d</span> <span class="string">'{ "ra": "180.07", "dec": "-83.553", "date_type": "JD", "date_min": "2460048.60", "date_max": "2460048.63" }'</span> \
      <span class="url">'https://hatpi.org/api/data?format=csv'</span>
          </pre>
          <button class="copy-button" data-target="pre-csv">Copy CSV üìã</button>
        </div>

        <div class="cli-block">
          <pre id="pre-votable" class="cli-query">
    # VOTable
    <span class="command">curl</span> <span class="option">-X</span> <span class="value">POST</span> \
      <span class="option">-H</span> <span class="string">"Content-Type: application/json"</span> \
      <span class="option">-d</span> <span class="string">'{ "ra": "180.07", "dec": "-83.553", "date_type": "JD", "date_min": "2460048.60", "date_max": "2460048.63" }'</span> \
      <span class="url">'https://hatpi.org/api/data?format=votable'</span>
          </pre>
          <button class="copy-button" data-target="pre-votable">Copy VOTable üìã</button>
        </div>

      </div>
    </div>
    {% endif %}


  </main>


  <!-- Copy-to-clipboard script -->
  <script src="/static/lightcurves.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const switchBox = document.getElementById("frame-switch");
      if (!switchBox) return;

      const objCard = document.getElementById("object-card");
      const twlCard = document.getElementById("twilight-card");

      // helper: mark every radio so the visible dot matches the view
      function setView(view) {
        document.querySelectorAll('input[name="frameType"]').forEach(r => {
          r.checked = (r.value === view);
        });
        objCard.style.display = (view === "object") ? "" : "none";
        twlCard.style.display = (view === "twilight") ? "" : "none";
      }

      /* ---------- initial sync (fixes missing dot on first load) ---------- */
      setView("{{ current_view }}");    // Jinja injects "object" or "twilight"
      /* -------------------------------------------------------------------- */

      // click-handler: switch cards + keep all radios in sync
      document.querySelectorAll('input[name="frameType"]').forEach(radio => {
        radio.addEventListener("change", () => setView(radio.value));
      });
    });

  </script>


  <script>
    document.addEventListener("DOMContentLoaded", () => {
      document.querySelectorAll('.copy-button').forEach(button => {
        const pre = document.getElementById(button.dataset.target);
        const originalText = button.textContent;
        button.addEventListener('click', () => {
          navigator.clipboard.writeText(pre.textContent.trim());
          button.textContent = 'Copied! ‚úÖ';
          setTimeout(() => button.textContent = originalText, 1500);
        });
      });
    });
  </script>


  <!-- ‚îÄ‚îÄ JS9 backdrop & modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div id="fits-backdrop" style="display:none;position:fixed;inset:0;
            background:rgba(0,0,0,.55);z-index:999;"></div>

  <style>
    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ JS9 modal + layout overrides ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

    /* fixed, centred modal shell */
    #fits-modal {
      position: fixed;
      top: 2vh;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      padding: 12px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, .4);

      /* fill most of the viewport but never exceed it */
      width: 96vw;
      max-width: 96vw;
      height: 96vh;
      max-height: 96vh;
      overflow: auto;

      z-index: 1000;
      display: none;
      padding-bottom: 50px;
      /* shown when you click ‚ÄúView‚Äù */
    }

    /* flex container holding the two columns */
    #js9-layout {
      display: flex;
      gap: 12px;
      /* breathing room between columns */
      width: 100%;
      /* inherit full modal width        */
      max-width: 100%;
      box-sizing: border-box;
      height: 100%;
      padding-bottom: 8px;
    }

    /* left column = JS9 core UI stack */
    #js9-left {
      flex: 1 1 0;
      /* start at 0, then take remaining space */
      min-width: 0;
      /* allow it to shrink on very small screens */
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    /* right column = info + magnifier */
    #js9-right {
      flex: 0 0 280px;
      /* fixed 280-px width */
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
    }

    /* bars span full width */
    #js9-viewerMenubar,
    #js9-viewerToolbar,
    #js9-viewerStatusbar {
      width: 100% !important;
      min-width: 0;
      box-sizing: border-box;

      flex: 0 0 auto;
      overflow-x: hidden !important;
    }

    /* give the status-bar enough room and stop it scrolling */
    #js9-viewerStatusbar {
      height: 28px !important;
      /* 24-28 px is usually plenty */
      overflow: visible !important;
      flex: 0 0 28px;
      /* reserve that space in the column */
      white-space: nowrap;
      /* stop long text from wrapping      */
    }


    /* JS9 canvas dominates height */
    #js9-viewer {
      flex: 1 1 0;
      width: 100% !important;
      /* adjust if you change bar heights */
      max-height: 100%;
    }

    /* plugins in the right column */
    #js9-viewerInfo,
    #js9-viewerMagnifier {
      flex: 1 1 0;
      overflow: auto;
    }

    /* close button */
    #js9-close {
      position: absolute;
      bottom: 18px;
      /* tweak to taste */
      left: 50%;
      transform: translateX(-50%);
      z-index: 1010;
      /* above the canvas */
      padding: 8px 18px;
      font-size: 0.95rem;
      border-radius: 8px !important;
    }


    /* let the toolbar take its natural height (‚âà32 px) */
    /* force toolbar to bigger height, overriding JS-9‚Äôs inline style */
    #js9-viewerToolbar {
      height: 55px !important;
      /* 32px works too; 36px leaves a small margin */
      overflow: visible !important;
      flex: 0 0 36px;
      /* make the flex column reserve the same space */
    }

    /* ‚îÄ‚îÄ status-bar: override JS9‚Äôs inline 17-px clamp ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    #viewerStatusbarContainer,
    #js9-viewerStatusbarContainer {
      /* JS9 uses one of these two ids */
      height: 28px !important;
      /* 24‚Äì28 px is plenty */
      overflow: visible !important;
      flex: 0 0 28px;
      /* left column now reserves 28 px */
    }

    /* be sure the inner bar also shows everything (belt-and-braces) */
    #viewerStatusbarContainer .JS9Statusbar {
      height: 100% !important;
      overflow: visible !important;
      white-space: nowrap;
      /* prevent line-wrap ‚áí no h-scroll */
    }
  </style>

  <div id="fits-modal">
    <div id="js9-layout"> <!-- flex container -->
      <div id="js9-left"> <!-- left column -->
        <div id="js9-viewerMenubar" class="JS9Menubar"></div>
        <div id="js9-viewerToolbar" class="JS9Toolbar"></div>

        <!--  NO data-width / data-height attributes here -->
        <div id="js9-viewer" class="JS9"></div>

        <div id="js9-viewerStatusbar" class="JS9Statusbar"></div>
      </div>

      <div id="js9-right"> <!-- right column -->
        <div id="js9-viewerInfo" class="JS9Info"></div>
        <div id="js9-viewerMagnifier" class="JS9Magnifier"></div>
      </div>
    </div>

    <button id="js9-close" class="visit-button" type="button">Close</button>
  </div>

  <script>
    function syncColorbarWidth() {
      const viewer = document.getElementById("js9-viewer");
      if (!viewer) return;

      // how much narrower you want the colour-bar:
      const OFFSET = 40;                // px   ‚Üê adjust here  (or use a %)

      const w = Math.max(50, viewer.clientWidth - OFFSET);   // never below 50 px

      const bar = document.getElementById("js9-viewerColorbarCanvas");
      if (!bar) return;

      const span = bar.parentElement;   // JS9ColorbarContainer
      const item = span.parentElement;  // JS9StatusbarItem

      [bar, span, item].forEach(el => {
        el.style.width = w + "px";
        el.style.maxWidth = w + "px";
      });
      item.style.flex = `0 0 ${w}px`;   // reserve that space in the row
    }



    document.addEventListener("DOMContentLoaded", () => {
      const modal = document.getElementById("fits-modal");
      const backdrop = document.getElementById("fits-backdrop");
      const closeBtn = document.getElementById("js9-close");
      document.addEventListener("keydown", evt => {
        if (evt.key === "Escape" && modal.style.display === "block") {
          closeBtn.click();                 // triggers the same handler
        }
      });

      /* helper ‚Äì resize JS9 to fill its div */
      function fillViewer() {
        const box = document.getElementById("js9-viewer");
        JS9.ResizeDisplay("js9-viewer", box.clientWidth, box.clientHeight);
      }

      /* open viewer on each ‚ÄúView‚Äù button */
      document.querySelectorAll(".view-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const kind = btn.dataset.kind || "red";

          const ihuid = btn.dataset.ihuid;
          const fnum = btn.dataset.fnum;
          const fitsURL = `/fits/${kind}/${ihuid}/${fnum}`;

          backdrop.style.display = "block";
          modal.style.display = "block";

          JS9.Load(fitsURL, {
            display: "js9-viewer",
            onload: () => {
              // JS9.SetScale("zscale", "js9-viewer");
              fillViewer();
              JS9.SetZoom("to fit", "js9-viewer");
              syncColorbarWidth();

              JS9.SetScale("zscale", { display: "js9-viewer" });
              JS9.SetWCSUnits("degrees", { display: "js9-viewer" });
              console.log("JS9 loaded & resized OK");
            }
          });
        });
      });


      /* keep viewer responsive on window resize */
      window.addEventListener("resize", () => {
        if (modal.style.display === "block") {
          fillViewer();
        }
        JS9.SetZoom("to fit", "js9-viewer");
        syncColorbarWidth();
      });

      /* close viewer */
      closeBtn.addEventListener("click", () => {
        JS9.CloseDisplay("js9-viewer");
        modal.style.display = "none";
        backdrop.style.display = "none";
      });
    });
  </script>

  {% if not current_user.is_authenticated %}
  {% include "_auth_modal.html" %}
  {% endif %}

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const tabLogin = document.getElementById("tab-login");
      const tabRegister = document.getElementById("tab-register");
      const formLogin = document.getElementById("login-form");
      const formReg = document.getElementById("register-form");

      /* helpers ----------------------------------------------------------- */
      function showLogin() {
        tabLogin.classList.add("active");
        tabRegister.classList.remove("active");
        formLogin.classList.add("active");
        formReg.classList.remove("active");
      }

      function showRegister() {
        tabRegister.classList.add("active");
        tabLogin.classList.remove("active");
        formReg.classList.add("active");
        formLogin.classList.remove("active");
      }

      /* tab-click handlers ------------------------------------------------ */
      tabLogin.addEventListener("click", showLogin);
      tabRegister.addEventListener("click", showRegister);

      /* always reset to Log in whenever the modal is opened --------------- */
      const backdrop = document.getElementById("auth-backdrop");
      backdrop.addEventListener("click", () => showLogin());   // close by clicking backdrop
      document.addEventListener("keydown", e => {
        if (e.key === "Escape") showLogin();                    // close with Esc
      });
      // If you have a dedicated ‚Äúclose‚Äù button, call showLogin() there too.
    });
  </script>



  {% with msgs = get_flashed_messages() %}
  {% if msgs %}
  <div id="toast">{{ msgs[0] }}</div>
  <script>
    const t = document.getElementById("toast");
    requestAnimationFrame(() => { t.style.opacity = 1; });
    setTimeout(() => { t.style.opacity = 0; }, 3500);      // fade after 3.5 s
  </script>
  {% endif %}
  {% endwith %}


</body>

</html>