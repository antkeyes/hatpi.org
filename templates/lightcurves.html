<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HATPI Data</title>
  <link rel="stylesheet" href="/static/lightcurves.css">
  <link rel="icon" href="/static/images/favicon.png" type="image/x-icon">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='js9/js9-allinone.css') }}">
  <script src="{{ url_for('static', filename='js9/js9-allinone.js') }}"></script>
</head>

<body class="lightcurves-page">
  <!-- Left Sidebar Navigation -->
  <nav id="lightcurves-navigation">
    <a href="https://hatpi.org" class="nav-home-link">üè°</a>

    <!-- Search Form inside the Sidebar -->
    <div id="search-form-sidebar">

      <h2 class="nav-section-title">
        <img src="/static/icons/search.svg" alt="Gear Icon" class="nav-icon">
        Search
      </h2>
      <form method="POST">
        <label for="ra">
          <img src="/static/icons/RA.png" alt="Gear Icon" class="small-icon">
          RA (deg)</label>
        <input type="text" id="ra" name="ra" placeholder="e.g. 180.07" value="{{ ra|default('') }}" />

        <label for="dec">
          <img src="/static/icons/DEC.png" alt="Gear Icon" class="small-icon">
          DEC (deg)</label>
        <input type="text" id="dec" name="dec" placeholder="e.g. -83.553" value="{{ dec|default('') }}" />

        <label for="date_type">Date Type</label>
        <select id="date_type" name="date_type">
          <option value="datetime" {% if date_type=='datetime' %}selected{% endif %}>datetime</option>
          <option value="JD" {% if date_type=='JD' %}selected{% endif %}>JD</option>
        </select>
        <small>If "datetime", format is YYYY-MM-DD.<br />If "JD", enter float such as 2459990.5.</small>

        <label for="date_min">Date Min</label>
        <input type="text" id="date_min" name="date_min" placeholder="YYYY-MM-DD or 2459990.5"
          value="{{ date_min_input|default('') }}" />

        <label for="date_max">Date Max</label>
        <input type="text" id="date_max" name="date_max" placeholder="YYYY-MM-DD or 2459991.5"
          value="{{ date_max_input|default('') }}" />

        <button type="submit" class="visit-button">Search</button>
      </form>

    </div>

  </nav>

  <!-- Main content area for query results -->
  <main>

    <section id="upcoming">
      <div class="section-card">
        <!-- <div class="title-container">
          <div class="title-row">
            <h1 class="section-title">Upcoming Data Releases</h1>
          </div>
        </div> -->
        <div class="content-area">
          <h1 class="section-title">Upcoming Data Releases</h1>
          <p>
            We‚Äôre excited to announce that stitched light curves and high-resolution image stamps will soon be available
            for direct viewing and download. In the meantime, our frame search feature lets you explore HATPI‚Äôs
            observations to determine if we‚Äôve captured the astronomical phenomena you‚Äôre researching.
          </p>
        </div>
      </div>
    </section>


    <section id="results">
      {% if error %}
      <p class="error-text">{{ error }}</p>
      {% endif %}

      {% if message %}
      <p class="message-text">{{ message }}</p>
      {% endif %}

      {% if frames is none %}
      <div class="section-card">
        <div class="title-container">
          <div class="title-row">
            <h1 class="section-title">‚¨ÖÔ∏è Awaiting search</h1>
          </div>
        </div>
        <div class="content-area">
          <!-- placeholder for before query is submitted -->
        </div>
      </div>

      {% elif frames %}
      <div class="section-card">
        <!-- New Title Container Layout for Results -->
        <div class="title-container">
          <!-- First row: Frames Found -->
          <div class="title-row">
            <div class="search-info-box">
              Frames Found: {{ total_count }}
            </div>
          </div>
          <!-- Second row: Query details -->
          <div class="title-row search-info-row">
            <div class="search-info-box">RA: {{ ra|default('N/A') }}</div>
            <div class="search-info-box">DEC: {{ dec|default('N/A') }}</div>
            <div class="search-info-box">Date Min: {{ date_min_input|default('N/A') }}</div>
            <div class="search-info-box">Date Max: {{ date_max_input|default('N/A') }}</div>
          </div>
        </div>
        <div class="content-area">
          <div class="table-wrapper">
            <form method="post" class="pagination-form">
              <!-- preserve all your search inputs as hidden fields -->
              <input type="hidden" name="ra" value="{{ ra }}">
              <input type="hidden" name="dec" value="{{ dec }}">
              <input type="hidden" name="date_type" value="{{ date_type }}">
              <input type="hidden" name="date_min" value="{{ date_min_input }}">
              <input type="hidden" name="date_max" value="{{ date_max_input }}">

              <!-- pagination controls -->
              <button type="submit" name="page" value="{{ page - 1 }}" {% if page <=1 %}disabled{% endif %}>
                ‚Üê Prev
              </button>
              <span>Page {{ page }} of {{ total_pages }}</span>
              <button type="submit" name="page" value="{{ page + 1 }}" {% if page>= total_pages %}disabled{% endif %}>
                Next ‚Üí
              </button>
            </form>

            <table class="frames-table">
              <thead>
                <tr>
                  <th>Object</th>
                  <th>IHUID</th>
                  <th>FNUM</th>
                  <!-- <th>Path</th> -->
                  <th>Observation Time (UTC)</th>
                  <th>EXPTIME</th>
                  <th>Sky Background (ADU)</th>
                  <th>Moon Distance (deg)</th>
                  <th>Sun Elevation (deg)</th>
                  <th>DS9</th>
                </tr>
              </thead>
              <tbody>
                {% for f in frames %}
                <tr>
                  <td>{{ f.OBJECT }}</td>
                  <td>{{ f.IHUID }}</td>
                  <td>{{ f.FNUM }}</td>
                  <!-- <td>{{ f.relpath }}</td> -->
                  <td>{{ f.datetime_obs }}</td>
                  <td>{{ f.EXPTIME }}</td>
                  <td>{{ f.sky_bg|default('N/A') }}</td>
                  <td>{{ f.moondist|default('N/A') }}</td>
                  <td>{{ f.sunelev|default('N/A') }}</td>
                  <td>
                    <button type="button" class="view-btn visit-button" data-ihuid="{{ f.IHUID }}"
                      data-fnum="{{ f.FNUM }}">
                      View
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      {% else %}
      <div class="section-card">
        <div class="title-container">
          <div class="title-row">
            <h2 class="section-title">Results</h2>
          </div>
        </div>
        <div class="content-area">
          <p>No frames found for that coordinate &amp; date range.</p>
        </div>
      </div>
      {% endif %}
    </section>

    <!-- CLI Query Card -->
    <div class="cli-section">
      <h1 class="section-title">Query the API from Your Terminal</h1>
      <div class="cli-query-container">

        <div class="cli-block">
          <pre id="pre-json" class="cli-query">
    # JSON
    <span class="command">curl</span> <span class="option">-X</span> <span class="value">POST</span> \
      <span class="option">-H</span> <span class="string">"Content-Type: application/json"</span> \
      <span class="option">-d</span> <span class="string">'{ "ra": "180.07", "dec": "-83.553", "date_type": "JD", "date_min": "2460048.60", "date_max": "2460048.63" }'</span> \
      <span class="url">'https://hatpi.org/api/data'</span>
          </pre>
          <button class="copy-button" data-target="pre-json">Copy JSON üìã</button>
        </div>

        <div class="cli-block">
          <pre id="pre-csv" class="cli-query">
    # CSV
    <span class="command">curl</span> <span class="option">-X</span> <span class="value">POST</span> \
      <span class="option">-H</span> <span class="string">"Content-Type: application/json"</span> \
      <span class="option">-d</span> <span class="string">'{ "ra": "180.07", "dec": "-83.553", "date_type": "JD", "date_min": "2460048.60", "date_max": "2460048.63" }'</span> \
      <span class="url">'https://hatpi.org/api/data?format=csv'</span>
          </pre>
          <button class="copy-button" data-target="pre-csv">Copy CSV üìã</button>
        </div>

        <div class="cli-block">
          <pre id="pre-votable" class="cli-query">
    # VOTable
    <span class="command">curl</span> <span class="option">-X</span> <span class="value">POST</span> \
      <span class="option">-H</span> <span class="string">"Content-Type: application/json"</span> \
      <span class="option">-d</span> <span class="string">'{ "ra": "180.07", "dec": "-83.553", "date_type": "JD", "date_min": "2460048.60", "date_max": "2460048.63" }'</span> \
      <span class="url">'https://hatpi.org/api/data?format=votable'</span>
          </pre>
          <button class="copy-button" data-target="pre-votable">Copy VOTable üìã</button>
        </div>

      </div>
    </div>


  </main>


  <!-- Copy-to-clipboard script -->
  <script src="/static/lightcurves.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      document.querySelectorAll('.copy-button').forEach(button => {
        const pre = document.getElementById(button.dataset.target);
        const originalText = button.textContent;
        button.addEventListener('click', () => {
          navigator.clipboard.writeText(pre.textContent.trim());
          button.textContent = 'Copied! ‚úÖ';
          setTimeout(() => button.textContent = originalText, 1500);
        });
      });
    });
  </script>


  <!-- ‚îÄ‚îÄ JS9 backdrop & modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div id="fits-backdrop" style="display:none;position:fixed;inset:0;
            background:rgba(0,0,0,.55);z-index:999;"></div>

  <style>
    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ JS9 modal + layout overrides ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

    /* fixed, centred modal shell */
    #fits-modal {
      position: fixed;
      top: 2vh;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      padding: 12px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, .4);

      /* fill most of the viewport but never exceed it */
      width: 96vw;
      max-width: 96vw;
      height: 96vh;
      max-height: 96vh;
      overflow: auto;

      z-index: 1000;
      display: none;
      padding-bottom: 50px;
      /* shown when you click ‚ÄúView‚Äù */
    }

    /* flex container holding the two columns */
    #js9-layout {
      display: flex;
      gap: 12px;
      /* breathing room between columns */
      width: 100%;
      /* inherit full modal width        */
      max-width: 100%;
      box-sizing: border-box;
      height: 100%;
      padding-bottom: 8px;
    }

    /* left column = JS9 core UI stack */
    #js9-left {
      flex: 1 1 0;
      /* start at 0, then take remaining space */
      min-width: 0;
      /* allow it to shrink on very small screens */
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    /* right column = info + magnifier */
    #js9-right {
      flex: 0 0 280px;
      /* fixed 280-px width */
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
    }

    /* bars span full width */
    #js9-viewerMenubar,
    #js9-viewerToolbar,
    #js9-viewerStatusbar {
      width: 100% !important;
      min-width: 0;
      box-sizing: border-box;

      flex: 0 0 auto;
      overflow-x: hidden !important;
    }

    /* give the status-bar enough room and stop it scrolling */
    #js9-viewerStatusbar {
      height: 28px !important;
      /* 24-28 px is usually plenty */
      overflow: visible !important;
      flex: 0 0 28px;
      /* reserve that space in the column */
      white-space: nowrap;
      /* stop long text from wrapping      */
    }


    /* JS9 canvas dominates height */
    #js9-viewer {
      flex: 1 1 0;
      width: 100% !important;
      /* adjust if you change bar heights */
      max-height: 100%;
    }

    /* plugins in the right column */
    #js9-viewerInfo,
    #js9-viewerMagnifier {
      flex: 1 1 0;
      overflow: auto;
    }

    /* close button */
    #js9-close {
      position: absolute;
      bottom: 18px;
      /* tweak to taste */
      left: 50%;
      transform: translateX(-50%);
      z-index: 1010;
      /* above the canvas */
      padding: 8px 18px;
      font-size: 0.95rem;
      border-radius: 8px !important;
    }


    /* let the toolbar take its natural height (‚âà32 px) */
    /* force toolbar to bigger height, overriding JS-9‚Äôs inline style */
    #js9-viewerToolbar {
      height: 55px !important;
      /* 32px works too; 36px leaves a small margin */
      overflow: visible !important;
      flex: 0 0 36px;
      /* make the flex column reserve the same space */
    }

    /* ‚îÄ‚îÄ status-bar: override JS9‚Äôs inline 17-px clamp ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    #viewerStatusbarContainer,
    #js9-viewerStatusbarContainer {
      /* JS9 uses one of these two ids */
      height: 28px !important;
      /* 24‚Äì28 px is plenty */
      overflow: visible !important;
      flex: 0 0 28px;
      /* left column now reserves 28 px */
    }

    /* be sure the inner bar also shows everything (belt-and-braces) */
    #viewerStatusbarContainer .JS9Statusbar {
      height: 100% !important;
      overflow: visible !important;
      white-space: nowrap;
      /* prevent line-wrap ‚áí no h-scroll */
    }
  </style>

  <div id="fits-modal">
    <div id="js9-layout"> <!-- flex container -->
      <div id="js9-left"> <!-- left column -->
        <div id="js9-viewerMenubar" class="JS9Menubar"></div>
        <div id="js9-viewerToolbar" class="JS9Toolbar"></div>

        <!--  NO data-width / data-height attributes here -->
        <div id="js9-viewer" class="JS9"></div>

        <div id="js9-viewerStatusbar" class="JS9Statusbar"></div>
      </div>

      <div id="js9-right"> <!-- right column -->
        <div id="js9-viewerInfo" class="JS9Info"></div>
        <div id="js9-viewerMagnifier" class="JS9Magnifier"></div>
      </div>
    </div>

    <button id="js9-close" class="visit-button" type="button">Close</button>
  </div>

  <script>
    function syncColorbarWidth() {
      const viewer = document.getElementById("js9-viewer");
      if (!viewer) return;

      // how much narrower you want the colour-bar:
      const OFFSET = 40;                // px   ‚Üê adjust here  (or use a %)

      const w = Math.max(50, viewer.clientWidth - OFFSET);   // never below 50 px

      const bar = document.getElementById("js9-viewerColorbarCanvas");
      if (!bar) return;

      const span = bar.parentElement;   // JS9ColorbarContainer
      const item = span.parentElement;  // JS9StatusbarItem

      [bar, span, item].forEach(el => {
        el.style.width = w + "px";
        el.style.maxWidth = w + "px";
      });
      item.style.flex = `0 0 ${w}px`;   // reserve that space in the row
    }



    document.addEventListener("DOMContentLoaded", () => {
      const modal = document.getElementById("fits-modal");
      const backdrop = document.getElementById("fits-backdrop");
      const closeBtn = document.getElementById("js9-close");
      document.addEventListener("keydown", evt => {
        if (evt.key === "Escape" && modal.style.display === "block") {
          closeBtn.click();                 // triggers the same handler
        }
      });

      /* helper ‚Äì resize JS9 to fill its div */
      function fillViewer() {
        const box = document.getElementById("js9-viewer");
        JS9.ResizeDisplay("js9-viewer", box.clientWidth, box.clientHeight);
      }

      /* open viewer on each ‚ÄúView‚Äù button */
      document.querySelectorAll(".view-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const fitsURL = `/fits/${btn.dataset.ihuid}/${btn.dataset.fnum}`;

          backdrop.style.display = "block";
          modal.style.display = "block";

          JS9.Load(fitsURL, {
            display: "js9-viewer",
            onload: () => {
              fillViewer();
              JS9.SetZoom("to fit", "js9-viewer");
              syncColorbarWidth();

              console.log("JS9 loaded & resized OK");
            }
          });
        });
      });

      /* keep viewer responsive on window resize */
      window.addEventListener("resize", () => {
        if (modal.style.display === "block") {
          fillViewer();
        }
        JS9.SetZoom("to fit", "js9-viewer");
        syncColorbarWidth();
      });

      /* close viewer */
      closeBtn.addEventListener("click", () => {
        JS9.CloseDisplay("js9-viewer");
        modal.style.display = "none";
        backdrop.style.display = "none";
      });
    });
  </script>




</body>

</html>